(function(global,factory){if(typeof define==='function'&&define.amd){define([],factory)}else if(typeof exports!=='undefined'){factory()}else{var mod={exports:{}};factory();global.compress=mod.exports}})(this,function(){'use strict';function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function toArrayImage(a){var b=[];var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=a[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var c=_step.value;b.push(c)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return b}var pubsub={_events:{},trigger:function trigger(a,b){if(!this._events[a])return null;var c=this._events[a];return c&&c.forEach(function(d){d(b)}),this},on:function on(a,b){return this._events[a]||(this._events[a]=[]),this._events[a].push(b),this}};pubsub.on('start',function(a){console.log(a)}),pubsub.trigger('start','Hello world'),window.compress=compress;function compress(a){return function(b){var c=b.target.files;toArrayImage(c).forEach(function(d){var g=null,i=null,j=d.name,k=d.type,l=d.size,m=null,n=null,o=0,p=0;g=performance.now();var q=null;read(d).then(loadImage).then(function(r){width=r.naturalWidth,height=r.naturalHeight;var _resize=resize(1080,null)(r),s=_resize.width,t=_resize.height;return m=s,n=t,convertImageToCanvas(m,n)(r)}).then(function(r){p=1;var s=convertCanvasToBase64(r),t=getExtension(s);return q=getStrip(t),loopCompression(r,l,1,524288,1,p)}).then(function(r){return o=getFileSize(r),stripData(r)}).then(function(r){i=performance.now();var s=i-g;return{data:r,timeElapsedSeconds:s/1000,name:j,size:l,baseStrip:q,sizeMB:l/1000000,finalSize:o,finalSizeMB:o/1000000,ext:k,finalWidth:m,finalHeight:n,width:width,height:height,sizeReduced:100*((l-o)/l),iterationCount:p}}).then(function(r){a(r)})})}}function initCanvas(_ref){var a=_ref.width,b=_ref.height,c=document.createElement('canvas');return c.getContext('2d'),c.width=a,c.height=b,c}function read(a){return new Promise(function(b,c){var d=new FileReader;d.addEventListener('load',function(g){getFileSize(g.target.result),b(g.target.result)},!1),d.addEventListener('error',function(g){c(g)}),d.readAsDataURL(a)})}function timer(){performance.now()}function loadImage(a){return new Promise(function(b,c){var d=new Image;d.addEventListener('load',function(){b(d)},!1),d.addEventListener('error',function(g){c(g)},!1),d.src=a})}function convertImageToCanvas(a,b){var c=document.createElement('canvas');return function(d){return c.width=a,c.height=b,c.getContext('2d').drawImage(d,0,0,c.width,c.height),c}}function convertCanvasToBase64(a){var b=a.toDataURL('image/jpeg',0.5);return b}function convertCanvasToImage(a){var b=new Image,c=a.toDataURL('image/jpeg',0.5);return b.src=c,b}function handleFiles(a){var b=a.target.files;[].concat(_toConsumableArray(b)).filter(filterImage)}function filterImage(a){if(a.type.match('image.*'))return['image/gif','image/jpeg','image/png'].indexOf(a.type)}function previewFile(){var a=document.querySelector('img'),b=document.querySelector('input[type=file]').files[0],c=new FileReader;c.addEventListener('load',function(){a.src=c.result},!1),b&&c.readAsDataURL(b)}function getImageBasedOnQuality(){canvas.toDataURL('image/jpeg',1),canvas.toDataURL('image/jpeg',0.5),canvas.toDataURL('image/jpeg',0.1)}function resize(a,b){return function(c){var d=c.naturalWidth,g=c.naturalHeight;if(!a&&!b)return c;var i=Math.min(d,a),j=Math.min(g,b);return i?{width:i,height:g/(d/i)}:{width:d/(g/j),height:j}}}function loopCompression(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,g=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,d=arguments[3],i=arguments[5],j=convertCanvasToBase64(a),k=getFileSize(j);return i+=1,k>d?loopCompression(a,k,c-0.1,g,d,i):c>g?loopCompression(a,k,c-0.1,g,d,i):0.5>c?j:j}function fileSizeFormatter(a){return{b:a,kb:a/1000,mb:a/1000000}}function getFileSize(a){var b=a.replace(/^data:image\/\w+;base64,/,'').length;return 3*b/4}function getExtension(a){var b=a.split(';')[0].match(/jpeg|png|gif/)[0];return b}function stripData(a){return a.replace(/^data:image\/\w+;base64,/,'')}function getStrip(a){return'data:'+a+';base64,'}});

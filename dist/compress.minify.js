(function(global,factory){if(typeof define==='function'&&define.amd){define(['module'],factory)}else if(typeof exports!=='undefined'){factory(module)}else{var mod={exports:{}};factory(mod);global.Compress=mod.exports}})(this,function(module){'use strict';function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError('Cannot call a class as a function')}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}var Compress=function Compress(){function a(p){return function(q){return e(q).then(function(r){if(p.startWidth=r.naturalWidth,p.startHeight=r.naturalHeight,p.resize){var _i=i(p.maxWidth,p.maxHeight)(r),s=_i.width,t=_i.height;p.endWidth=s,p.endHeight=t}else p.endWidth=r.naturalWidth,p.endHeight=r.naturalHeight;return f(p.endWidth,p.endHeight)(r)}).then(function(r){return p.iterations=1,p.base64prefix=o(m(g(r))),j(r,p.startSize,p.quality,p.size,p.minQuality,p.iterations)}).then(function(r){return p.finalSize=l(r),n(r)}).then(function(r){p.end=performance.now();var s=p.end-p.start;return{data:r,timeElapsedInSeconds:s/1000,alt:p.alt,startSizeInMB:k(p.startSize).MB,base64prefix:p.base64prefix,finalSizeInMB:k(p.finalSize).MB,ext:p.ext,quality:p.quality,endWidthInPX:p.endWidth,endHeightInPX:p.endHeight,startWidthInPX:p.startWidth,startHeightInPX:p.startHeight,sizeReducedInPercent:100*((p.startSize-p.finalSize)/p.startSize),iterations:p.iterations}})}}function b(p,q){var r=new Photo(q);return r.start=performance.now(),r.alt=p.name,r.ext=p.type,r.startSize=p.size,d(p).then(a(r))}function c(p,q){return Promise.all(p.map(function(r){return b(r,q)}))}function d(p){return new Promise(function(q,r){var s=new FileReader;s.addEventListener('load',function(t){q(t.target.result)},!1),s.addEventListener('error',function(t){r(t)}),s.readAsDataURL(p)})}function e(p){return new Promise(function(q,r){var s=new Image;s.addEventListener('load',function(){q(s)},!1),s.addEventListener('error',function(t){r(t)},!1),s.src=p})}function f(p,q){var r=document.createElement('canvas'),s=r.getContext('2d');return function(t){return r.width=p,r.height=q,s.drawImage(t,0,0,r.width,r.height),r}}function g(p){var q=p.toDataURL('image/jpeg',0.5);return q}function i(p,q){return function(r){var s=r.naturalWidth,t=r.naturalHeight;if(!p&&!q)return{width:s,height:t};var u=Math.min(s,p),v=Math.min(t,q);return u?{width:u,height:t/(s/u)}:{width:s/(t/v),height:v}}}function j(p,q){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,t=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,s=arguments[3],u=arguments[5],v=g(p),x=l(v);return u+=1,x>s?j(p,x,r-0.1,t,s,u):r>t?j(p,x,r-0.1,t,s,u):0.5>r?v:v}function k(p){return{KB:p/1000,MB:p/1000000}}function l(p){var q=p.replace(/^data:image\/\w+;base64,/,'').length;return 3*q/4}function m(p){var q=p.split(';')[0].match(/jpeg|png|gif/)[0];return q}function n(p){return p.replace(/^data:image\/\w+;base64,/,'')}function o(p){return'data:'+p+';base64,'}return{compress:c,attach:function attach(q,r){return new Promise(function(s){var t=document.querySelector(q);t.setAttribute('accept','image/*'),t.addEventListener('change',function(u){var v=c([].concat(_toConsumableArray(u.target.files)),r);s(v)},!1)})}}};var Photo=function Photo(a){_classCallCheck(this,Photo),this.start=performance.now(),this.end=null,this.alt=null,this.ext=null,this.startSize=null,this.startWidth=null,this.startHeight=null,this.quality=a&&a.quality?Math.abs(a.quality):0.75,this.stepQuality=0.5,this.size=a&&a.size?1000*(1000*a.size):2000000,this.endSize=null,this.endWidth=null,this.endHeight=null,this.iterations=0,this.base64prefix=null,this.resize=!0,this.maxWidth=1920,this.maxHeight=1920};module.exports=Compress});
